<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>readme.html</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<pre># agentkeepalive

[![NPM version][npm-image]][npm-url]
[![Known Vulnerabilities][snyk-image]][snyk-url]
[![Node.js CI](https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml/badge.svg)](https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml)
[![npm download][download-image]][download-url]

[npm-image]: https://img.shields.io/npm/v/agentkeepalive.svg?style=flat
[npm-url]: https://npmjs.org/package/agentkeepalive
[snyk-image]: https://snyk.io/test/npm/agentkeepalive/badge.svg?style=flat-square
[snyk-url]: https://snyk.io/test/npm/agentkeepalive
[download-image]: https://img.shields.io/npm/dm/agentkeepalive.svg?style=flat-square
[download-url]: https://npmjs.org/package/agentkeepalive

The enhancement features `keep alive` `http.Agent`. Support `http` and `https`.

## What&#x27;s different from original `http.Agent`?

- `keepAlive=true` by default
- Disable Nagle&#x27;s algorithm: `socket.setNoDelay(true)`
- Add free socket timeout: avoid long time inactivity socket leak in the free-sockets queue.
- Add active socket timeout: avoid long time inactivity socket leak in the active-sockets queue.
- TTL for active socket.

## Node.js version required

Support Node.js &gt;= `8.0.0`

## Install

```bash
$ npm install agentkeepalive --save
```

## new Agent([options])

* `options` {Object} Set of configurable options to set on the agent.
  Can have the following fields:
  * `keepAlive` {Boolean} Keep sockets around in a pool to be used by
    other requests in the future. Default = `true`.
  * `keepAliveMsecs` {Number} When using the keepAlive option, specifies the initial delay
    for TCP Keep-Alive packets. Ignored when the keepAlive option is false or undefined. Defaults to 1000.
    Default = `1000`.  Only relevant if `keepAlive` is set to `true`.
  * `freeSocketTimeout`: {Number} Sets the free socket to timeout
    after `freeSocketTimeout` milliseconds of inactivity on the free socket.
    The default [server-side timeout](https://nodejs.org/api/http.html#serverkeepalivetimeout) is 5000 milliseconds, to [avoid ECONNRESET exceptions](https://medium.com/ssense-tech/reduce-networking-errors-in-nodejs-23b4eb9f2d83), we set the default value to `4000` milliseconds.
    Only relevant if `keepAlive` is set to `true`.
  * `timeout`: {Number} Sets the working socket to timeout
    after `timeout` milliseconds of inactivity on the working socket.
    Default is `freeSocketTimeout * 2` so long as that value is greater than or equal to 8 seconds, otherwise the default is 8 seconds.
  * `maxSockets` {Number} Maximum number of sockets to allow per
    host. Default = `Infinity`.
  * `maxFreeSockets` {Number} Maximum number of sockets (per host) to leave open
    in a free state. Only relevant if `keepAlive` is set to `true`.
    Default = `256`.
  * `socketActiveTTL` {Number} Sets the socket active time to live, even if it&#x27;s in use.
    If not set, the behaviour keeps the same (the socket will be released only when free)
    Default = `null`.

## Usage

```js
const http = require(&#x27;http&#x27;);
const HttpAgent = require(&#x27;agentkeepalive&#x27;).HttpAgent;

const keepaliveAgent = new HttpAgent({
  maxSockets: 100,
  maxFreeSockets: 10,
  timeout: 60000, // active socket keepalive for 60 seconds
  freeSocketTimeout: 30000, // free socket keepalive for 30 seconds
});

const options = {
  host: &#x27;cnodejs.org&#x27;,
  port: 80,
  path: &#x27;/&#x27;,
  method: &#x27;GET&#x27;,
  agent: keepaliveAgent,
};

const req = http.request(options, res =&gt; {
  console.log(&#x27;STATUS: &#x27; + res.statusCode);
  console.log(&#x27;HEADERS: &#x27; + JSON.stringify(res.headers));
  res.setEncoding(&#x27;utf8&#x27;);
  res.on(&#x27;data&#x27;, function (chunk) {
    console.log(&#x27;BODY: &#x27; + chunk);
  });
});
req.on(&#x27;error&#x27;, e =&gt; {
  console.log(&#x27;problem with request: &#x27; + e.message);
});
req.end();

setTimeout(() =&gt; {
  if (keepaliveAgent.statusChanged) {
    console.log(&#x27;[%s] agent status changed: %j&#x27;, Date(), keepaliveAgent.getCurrentStatus());
  }
}, 2000);

```

### `getter agent.statusChanged`

counters have change or not after last checkpoint.

### `agent.getCurrentStatus()`

`agent.getCurrentStatus()` will return a object to show the status of this agent:

```js
{
  createSocketCount: 10,
  closeSocketCount: 5,
  timeoutSocketCount: 0,
  requestCount: 5,
  freeSockets: { &#x27;localhost:57479:&#x27;: 3 },
  sockets: { &#x27;localhost:57479:&#x27;: 5 },
  requests: {}
}
```

### Support `https`

```js
const https = require(&#x27;https&#x27;);
const HttpsAgent = require(&#x27;agentkeepalive&#x27;).HttpsAgent;

const keepaliveAgent = new HttpsAgent();
// https://www.google.com/search?q=nodejs&amp;sugexp=chrome,mod=12&amp;sourceid=chrome&amp;ie=UTF-8
const options = {
  host: &#x27;www.google.com&#x27;,
  port: 443,
  path: &#x27;/search?q=nodejs&amp;sugexp=chrome,mod=12&amp;sourceid=chrome&amp;ie=UTF-8&#x27;,
  method: &#x27;GET&#x27;,
  agent: keepaliveAgent,
};

const req = https.request(options, res =&gt; {
  console.log(&#x27;STATUS: &#x27; + res.statusCode);
  console.log(&#x27;HEADERS: &#x27; + JSON.stringify(res.headers));
  res.setEncoding(&#x27;utf8&#x27;);
  res.on(&#x27;data&#x27;, chunk =&gt; {
    console.log(&#x27;BODY: &#x27; + chunk);
  });
});

req.on(&#x27;error&#x27;, e =&gt; {
  console.log(&#x27;problem with request: &#x27; + e.message);
});
req.end();

setTimeout(() =&gt; {
  console.log(&#x27;agent status: %j&#x27;, keepaliveAgent.getCurrentStatus());
}, 2000);
```

### Support `req.reusedSocket`

This agent implements the `req.reusedSocket` to determine whether a request is send through a reused socket.

When server closes connection at unfortunate time ([keep-alive race](https://code-examples.net/en/q/28a8069)), the http client will throw a `ECONNRESET` error. Under this circumstance, `req.reusedSocket` is useful when we want to retry the request automatically.

```js
const http = require(&#x27;http&#x27;);
const HttpAgent = require(&#x27;agentkeepalive&#x27;).HttpAgent;
const agent = new HttpAgent();

const req = http
  .get(&#x27;http://localhost:3000&#x27;, { agent }, (res) =&gt; {
    // ...
  })
  .on(&#x27;error&#x27;, (err) =&gt; {
    if (req.reusedSocket &amp;&amp; err.code === &#x27;ECONNRESET&#x27;) {
      // retry the request or anything else...
    }
  })
```

This behavior is consistent with Node.js core. But through `agentkeepalive`, you can use this feature in older Node.js version.

## [Benchmark](https://github.com/node-modules/agentkeepalive/tree/master/benchmark)

run the benchmark:

```bash
cd benchmark
sh start.sh
```

Intel(R) Core(TM)2 Duo CPU     P8600  @ 2.40GHz

node@v0.8.9

50 maxSockets, 60 concurrent, 1000 requests per concurrent, 5ms delay

Keep alive agent (30 seconds):

```js
Transactions:          60000 hits
Availability:         100.00 %
Elapsed time:          29.70 secs
Data transferred:        14.88 MB
Response time:            0.03 secs
Transaction rate:      2020.20 trans/sec
Throughput:           0.50 MB/sec
Concurrency:           59.84
Successful transactions:       60000
Failed transactions:             0
Longest transaction:          0.15
Shortest transaction:         0.01
```

Normal agent:

```js
Transactions:          60000 hits
Availability:         100.00 %
Elapsed time:          46.53 secs
Data transferred:        14.88 MB
Response time:            0.05 secs
Transaction rate:      1289.49 trans/sec
Throughput:           0.32 MB/sec
Concurrency:           59.81
Successful transactions:       60000
Failed transactions:             0
Longest transaction:          0.45
Shortest transaction:         0.00
```

Socket created:

```bash
[proxy.js:120000] keepalive, 50 created, 60000 requestFinished, 1200 req/socket, 0 requests, 0 sockets, 0 unusedSockets, 50 timeout
{&quot; &lt;10ms&quot;:662,&quot; &lt;15ms&quot;:17825,&quot; &lt;20ms&quot;:20552,&quot; &lt;30ms&quot;:17646,&quot; &lt;40ms&quot;:2315,&quot; &lt;50ms&quot;:567,&quot; &lt;100ms&quot;:377,&quot; &lt;150ms&quot;:56,&quot; &lt;200ms&quot;:0,&quot; &gt;=200ms+&quot;:0}
----------------------------------------------------------------
[proxy.js:120000] normal   , 53866 created, 84260 requestFinished, 1.56 req/socket, 0 requests, 0 sockets
{&quot; &lt;10ms&quot;:75,&quot; &lt;15ms&quot;:1112,&quot; &lt;20ms&quot;:10947,&quot; &lt;30ms&quot;:32130,&quot; &lt;40ms&quot;:8228,&quot; &lt;50ms&quot;:3002,&quot; &lt;100ms&quot;:4274,&quot; &lt;150ms&quot;:181,&quot; &lt;200ms&quot;:18,&quot; &gt;=200ms+&quot;:33}
```

## License

[MIT](LICENSE)

&lt;!-- GITCONTRIBUTOR_START --&gt;

## Contributors

|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/156269?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;fengmk2&lt;/b&gt;&lt;/sub&gt;](https://github.com/fengmk2)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/985607?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;dead-horse&lt;/b&gt;&lt;/sub&gt;](https://github.com/dead-horse)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/5557458?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;AndrewLeedham&lt;/b&gt;&lt;/sub&gt;](https://github.com/AndrewLeedham)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/5243774?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;ngot&lt;/b&gt;&lt;/sub&gt;](https://github.com/ngot)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/25919630?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;wrynearson&lt;/b&gt;&lt;/sub&gt;](https://github.com/wrynearson)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/26738844?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;aaronArinder&lt;/b&gt;&lt;/sub&gt;](https://github.com/aaronArinder)&lt;br/&gt;|
| :---: | :---: | :---: | :---: | :---: | :---: |
|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/10976983?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;alexpenev-s&lt;/b&gt;&lt;/sub&gt;](https://github.com/alexpenev-s)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/959726?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;blemoine&lt;/b&gt;&lt;/sub&gt;](https://github.com/blemoine)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/398027?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;bdehamer&lt;/b&gt;&lt;/sub&gt;](https://github.com/bdehamer)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/4985201?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;DylanPiercey&lt;/b&gt;&lt;/sub&gt;](https://github.com/DylanPiercey)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/3770250?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;cixel&lt;/b&gt;&lt;/sub&gt;](https://github.com/cixel)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/2883231?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;HerringtonDarkholme&lt;/b&gt;&lt;/sub&gt;](https://github.com/HerringtonDarkholme)&lt;br/&gt;|
|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/1433247?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;denghongcai&lt;/b&gt;&lt;/sub&gt;](https://github.com/denghongcai)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/1847934?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;kibertoad&lt;/b&gt;&lt;/sub&gt;](https://github.com/kibertoad)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/5236150?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;pangorgo&lt;/b&gt;&lt;/sub&gt;](https://github.com/pangorgo)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/588898?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;mattiash&lt;/b&gt;&lt;/sub&gt;](https://github.com/mattiash)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/182440?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;nabeelbukhari&lt;/b&gt;&lt;/sub&gt;](https://github.com/nabeelbukhari)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/1411117?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;pmalouin&lt;/b&gt;&lt;/sub&gt;](https://github.com/pmalouin)&lt;br/&gt;|
[&lt;img src=&quot;https://avatars.githubusercontent.com/u/1404810?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;SimenB&lt;/b&gt;&lt;/sub&gt;](https://github.com/SimenB)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/2630384?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;vinaybedre&lt;/b&gt;&lt;/sub&gt;](https://github.com/vinaybedre)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/10933333?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;starkwang&lt;/b&gt;&lt;/sub&gt;](https://github.com/starkwang)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/6897780?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;killagu&lt;/b&gt;&lt;/sub&gt;](https://github.com/killagu)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/15345331?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;tony-gutierrez&lt;/b&gt;&lt;/sub&gt;](https://github.com/tony-gutierrez)&lt;br/&gt;|[&lt;img src=&quot;https://avatars.githubusercontent.com/u/5856440?v=4&quot; width=&quot;100px;&quot;/&gt;&lt;br/&gt;&lt;sub&gt;&lt;b&gt;whxaxes&lt;/b&gt;&lt;/sub&gt;](https://github.com/whxaxes)&lt;br/&gt;

This project follows the git-contributor [spec](https://github.com/xudafeng/git-contributor), auto updated at `Sat Aug 05 2023 02:36:31 GMT+0800`.

&lt;!-- GITCONTRIBUTOR_END --&gt;
</pre>
</body>
</html>