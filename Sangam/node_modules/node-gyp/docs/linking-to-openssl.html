<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>linking-to-openssl.html</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<pre>A handful of native addons require linking to OpenSSL in one way or another. This introduces a small challenge since node will sometimes bundle OpenSSL statically (the default for node &gt;= v0.8.x), or sometimes dynamically link to the system OpenSSL (default for node &lt;= v0.6.x).

Good native addons should account for both scenarios. It&#x27;s recommended that you use the `binding.gyp` file provided below as a starting-point for any addon that needs to use OpenSSL:

``` python
{
  &#x27;variables&#x27;: {
    # node v0.6.x doesn&#x27;t give us its build variables,
    # but on Unix it was only possible to use the system OpenSSL library,
    # so default the variable to &quot;true&quot;, v0.8.x node and up will overwrite it.
    &#x27;node_shared_openssl%&#x27;: &#x27;true&#x27;
  },
  &#x27;targets&#x27;: [
    {
      &#x27;target_name&#x27;: &#x27;binding&#x27;,
      &#x27;sources&#x27;: [
        &#x27;src/binding.cc&#x27;
      ],
      &#x27;conditions&#x27;: [
        [&#x27;node_shared_openssl==&quot;false&quot;&#x27;, {
          # so when &quot;node_shared_openssl&quot; is &quot;false&quot;, then OpenSSL has been
          # bundled into the node executable. So we need to include the same
          # header files that were used when building node.
          &#x27;include_dirs&#x27;: [
            &#x27;&lt;(node_root_dir)/deps/openssl/openssl/include&#x27;
          ],
          &quot;conditions&quot; : [
            [&quot;target_arch==&#x27;ia32&#x27;&quot;, {
              &quot;include_dirs&quot;: [ &quot;&lt;(node_root_dir)/deps/openssl/config/piii&quot; ]
            }],
            [&quot;target_arch==&#x27;x64&#x27;&quot;, {
              &quot;include_dirs&quot;: [ &quot;&lt;(node_root_dir)/deps/openssl/config/k8&quot; ]
            }],
            [&quot;target_arch==&#x27;arm&#x27;&quot;, {
              &quot;include_dirs&quot;: [ &quot;&lt;(node_root_dir)/deps/openssl/config/arm&quot; ]
            }]
          ]
        }]
      ]
    }
  ]
}
```

This ensures that when OpenSSL is statically linked into `node` then, the bundled OpenSSL headers are included, but when the system OpenSSL is in use, then only those headers will be used.

## Windows?

As you can see this baseline `binding.gyp` file only accounts for the Unix scenario. Currently on Windows the situation is a little less ideal. On Windows, OpenSSL is _always_ statically compiled into the `node` executable, so ideally it would be possible to use that copy of OpenSSL when building native addons.

Unfortunately it doesn&#x27;t seem like that is possible at the moment, as there would need to be tweaks made to the generated `node.lib` file to include the openssl glue functions, or a new `openssl.lib` file would need to be created during the node build. I&#x27;m not sure which is the easiest/most feasible.

In the meantime, one possible solution is using another copy of OpenSSL, which is what [`node-bcrypt`](https://github.com/ncb000gt/node.bcrypt.js) currently does. Adding something like this to your `binding.gyp` file&#x27;s `&quot;conditions&quot;` block would enable this:

``` python
    [ &#x27;OS==&quot;win&quot;&#x27;, {
      &#x27;conditions&#x27;: [
        # &quot;openssl_root&quot; is the directory on Windows of the OpenSSL files.
        # Check the &quot;target_arch&quot; variable to set good default values for
        # both 64-bit and 32-bit builds of the module.
        [&#x27;target_arch==&quot;x64&quot;&#x27;, {
          &#x27;variables&#x27;: {
            &#x27;openssl_root%&#x27;: &#x27;C:/OpenSSL-Win64&#x27;
          },
        }, {
          &#x27;variables&#x27;: {
            &#x27;openssl_root%&#x27;: &#x27;C:/OpenSSL-Win32&#x27;
          },
        }],
      ],
      &#x27;libraries&#x27;: [ 
        &#x27;-l&lt;(openssl_root)/lib/libeay32.lib&#x27;,
      ],
      &#x27;include_dirs&#x27;: [
        &#x27;&lt;(openssl_root)/include&#x27;,
      ],
    }]
```

Now you can direct your users to install OpenSSL on Windows from here (be sure to tell them to install the 64-bit version if they&#x27;re compiling against a 64-bit version of node): http://slproweb.com/products/Win32OpenSSL.html

Also note that both `node-gyp` and `npm` allow you to overwrite that default `openssl_root` variable on the command line:

``` bash
$ node-gyp rebuild --openssl-root=&quot;C:\Users\Nathan\Desktop\openssl&quot;
```</pre>
</body>
</html>